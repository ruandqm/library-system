name: Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:unit -- --run

      - name: Generate coverage report
        run: npm run test:coverage -- --run

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/coverage-final.json
          flags: unittests

  integration-tests:
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ping: 1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      MONGODB_URI: mongodb://localhost:27017
      MONGODB_DB: library-test
      NEXTAUTH_SECRET: test-secret-key
      NEXTAUTH_URL: http://localhost:3000

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Wait for MongoDB to be ready
        run: |
          n=0
          until [ $n -ge 30 ]; do
            if command -v mongosh &> /dev/null; then
              if mongosh --host localhost:27017 --eval "db.adminCommand({ping: 1})" --quiet 2>/dev/null; then
                echo "MongoDB is ready!"
                exit 0
              fi
            else
              # Fallback: try to connect using Node.js
              if node -e "const { MongoClient } = require('mongodb'); (async () => { const client = new MongoClient('mongodb://localhost:27017', { serverSelectionTimeoutMS: 2000 }); try { await client.connect(); await client.close(); process.exit(0); } catch { process.exit(1); } })()" 2>/dev/null; then
                echo "MongoDB is ready!"
                exit 0
              fi
            fi
            echo "Waiting for MongoDB... ($n/30)"
            sleep 2
            n=$((n+1))
          done
          echo "MongoDB did not become ready in time"
          exit 1

      - name: Run integration tests
        run: npm run test:integration -- --run
